{% extends "base.html" %}

{% block main_content %}
  {% if party %}
    <div class="dashboard-grid">
      <!-- LEFT COLUMN: existing info/controls -->
      <div class="left-col">
        <h1>{{ party.name }}</h1>
        <a href="{{ url_for('my_parties') }}">
            Return to My Code Parties
        </a>

        <h2>Party Details</h2>
        <p><strong>Goal:</strong> {{ party.party_goal }} problems</p>
        <p><strong>Start:</strong> {{ party.party_start }}</p>
        <p><strong>End:</strong> {{ party.party_end }}</p>

        <hr>

        <h3>Current Members</h3>
        <ul>
          {% for member in members %}
            <li>
              <div class="user-wrapper people-user-cell" tabindex="0">
                <!-- Clickable name that triggers the popover -->
                <div class="people-user-cell">
                  <span>{{ member.name }} ({{ member.username }})</span>
                </div>

                <div class="user-popover">
                  <a href="{{ url_for('profile', pid=member.pid) }}">
                      View LeetParty Profile
                  </a>

                  <a href="https://leetcode.com/u/{{ member.lc_username }}/"
                  target="_blank" rel="noopener">
                      View LeetCode Profile
                  </a>
              </div>

                {% if member.pid != session['pid'] %}
                <!-- Remove button stays inside the wrapper -->
                <form method="POST" action="{{ url_for('remove_member', cpid=party.cpid) }}">
                  <input type="hidden" name="pid" value="{{ member.pid }}">
                  <button class="btn btn-sm" type="submit">Remove</button>
                </form>
                {% else %}
                <span>(You)</span>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>


        <a class="btn" href="{{ url_for('refresh_party', cpid=party.cpid) }}">
          Refresh Full Party Stats
          Refresh Full Party Stats
        </a>


        {% if party.last_bulk_refresh %}
          <p><em>Last refreshed for this party: {{ party.last_bulk_refresh }}</em></p>
        {% else %}
          <p><em>No refresh yet.</em></p>
        {% endif %}

        <hr>

        <h3>Invite Connections</h3>
        {% if connections %}
          {% for user in connections %}
            <div class="user-wrapper people-user-cell" tabindex="0">
              <div class="people-user-cell">
                  <span>{{ user.name }} ({{ user.username }})</span>
              </div>

              <div class="user-popover">
                  <a href="{{ url_for('profile', pid=user.pid) }}">
                      View LeetParty Profile
                  </a>

                  <a href="https://leetcode.com/u/{{ user.lc_username }}/"
                  target="_blank" rel="noopener">
                      View LeetCode Profile
                  </a>
              </div>

              <form method="POST" action="{{ url_for('add_member', cpid=party.cpid) }}">
                <input type="hidden" name="pid" value="{{ user.pid }}">
                <button class="btn btn-sm" type="submit">Add</button>
              </form>
            </div>
          {% endfor %}
        {% else %}
          <p>No connections available to invite.</p>
        {% endif %}

      </div>

      <!-- RIGHT COLUMN: graphs -->
      <div class="right-col">
        <div class="cardish">
          <h2>Group Progress</h2>
          <div class="progress-wrap">
            <div class="progress-outer">
              <div id="progressInner" class="progress-inner"></div>
            </div>
            <div class="muted" id="progressText">0 / 0</div>
          </div>
        </div>

        <div class="cardish">
          <h2>Problems Solved per Person</h2>
          <div class="chart-wrap">
            <canvas id="barChart"></canvas>
          </div>
        </div>

        <div class="cardish">
          <h2>Cumulative Problems Over Time</h2>
          <div class="chart-wrap">
            <canvas id="lineChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      const PARTY_CPID = {{ party.cpid | tojson }};
      const PRIMARY_COLOR = "#5c6536";
      const PRIMARY_DARK = "#262a0f";

      let barChart = null;
      let lineChart = null;

      function setProgress(done, goal) {
        const pct = goal > 0 ? Math.min(done / goal, 1) : 0;
        document.getElementById("progressInner").style.width = (pct * 100).toFixed(1) + "%";
        document.getElementById("progressText").textContent = `${done} / ${goal}`;
      }

      function renderBar(bar) {
        const ctx = document.getElementById("barChart");
        if (barChart) barChart.destroy();

        barChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: bar.labels,
            datasets: [{
              label: "Problems",
              data: bar.counts,
              backgroundColor: PRIMARY_COLOR,
              borderColor: PRIMARY_DARK,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { title: { display: true, text: "Member" } },
              y: { beginAtZero: true, title: { display: true, text: "Problems Solved" } }
            }
          }
        });
      }

      const hoverLinePlugin = {
        id: "hoverLine",
        afterDraw(chart, args, pluginOptions) {
          if (chart.config.type !== "line") return;

          const tooltip = chart.tooltip;
          if (!tooltip || !tooltip.getActiveElements().length) return;

          const { ctx, chartArea: { top, bottom } } = chart;
          const x = tooltip.getActiveElements()[0].element.x;

          ctx.save();
          ctx.beginPath();
          ctx.moveTo(x, top);
          ctx.lineTo(x, bottom);
          ctx.lineWidth = pluginOptions?.lineWidth ?? 1;
          ctx.strokeStyle = pluginOptions?.color ?? "rgba(0,0,0,0.25)";
          ctx.stroke();
          ctx.restore();
        }
      };


      Chart.register(hoverLinePlugin);

      function renderLine(line) {
        const ctx = document.getElementById("lineChart");
        if (lineChart) lineChart.destroy();

        function hexToRgba(hex, alpha) {
          const r = parseInt(hex.slice(1, 3), 16);
          const g = parseInt(hex.slice(3, 5), 16);
          const b = parseInt(hex.slice(5, 7), 16);
          return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function opacityForIndex(i, total) {
          const min = 0.3;
          const max = 0.9;
          if (total <= 1) return max;
          return max - (i * (max - min)) / (total - 1);
        }

        const entries = Object.entries(line.series);

        const people = entries.filter(([name]) => name !== "Total");
        const totalEntry = entries.find(([name]) => name === "Total");

        const datasets = [];

        // Individual people — same color, different opacity
        people.forEach(([name, values], i) => {
          const alpha = opacityForIndex(i, people.length);
          const color = hexToRgba(PRIMARY_COLOR, alpha);

          datasets.push({
            label: name,
            data: values,
            borderColor: color,
            backgroundColor: color,
            tension: 0.2,
            borderWidth: 1.5,
            fill: false,
            pointRadius: 0,
            pointHoverRadius: 0
          });
        });

        // Total line — fully opaque, thicker
        if (totalEntry) {
          const solid = hexToRgba(PRIMARY_COLOR, 1.0);
          datasets.push({
            label: "Total",
            data: totalEntry[1],
            borderColor: solid,
            backgroundColor: solid,
            tension: 0.2,
            borderWidth: 3,
            fill: false,
            pointRadius: 0,
            pointHoverRadius: 0
          });
        }

        lineChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: line.dates,
            datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,

            interaction: {
              mode: "index",
              intersect: false
            },

            plugins: {
              tooltip: { enabled: true },
              legend: { position: "bottom" },
              hoverLine: { color: "rgba(0,0,0,0.25)", lineWidth: 2 }
            },


            scales: {
              x: {
                title: {
                  display: true,
                  text: "Date"
                }
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Cumulative Problems"
                }
              }
            }
          }

        });
      }

      async function loadCharts() {
        const resp = await fetch(`/api/party/${PARTY_CPID}/charts`);
        const data = await resp.json();

        setProgress(data.progress.done, data.progress.goal);
        renderBar(data.bar);
        renderLine(data.line);
      }

      loadCharts();
    </script>

  {% else %}
    <h2>You are not in any party yet.</h2>
    <a href="{{ url_for('create_party') }}" class="btn btn-primary mt-3">Create a Party</a>
  {% endif %}
</div>
{% endblock %}
